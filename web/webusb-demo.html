<head>
    <title>WebUSB + Arduino Demo</title>
</head>
<style>
    div {
        width: 200px;
        padding: 20px;
        margin: 10px;
        font-family: Arial, Helvetica, sans-serif;
        text-align: center;
        background-color: #eee;
        cursor: pointer;
    }
    div:hover {
        background-color: #ddd;
    }
</style>
<script src="lib/jquery.min.js"></script>
<body>
    <div class="button-connect">Connect to USB devices</div>
    <div class="button-vote" party="0">Vote Democracy</div>
    <div class="button-vote" party="1">Vote Communism</div>
</body>
<script>
    window.device = null
    // Bind connect button
    $('.button-connect').click(function(){
        navigator.usb.requestDevice({ filters: [{ vendorId: 0x2341 }] })
        .then(selectedDevice => {
            window.device = selectedDevice;
            return device.open(); // Begin a session.
        })
        .then(() => {
            console.log(device.productName);      // "Arduino Micro"
            console.log(device.manufacturerName); // "Arduino LLC"
        })
        .then(() => device.selectConfiguration(1)) // Select configuration .1 for the device.
        .then(() => device.claimInterface(2)) // Request exclusive control over interface #2.
        .then(() => device.controlTransferOut({
            requestType: 'class',
            recipient: 'interface',
            request: 0x22,
            value: 0x01,
            index: 0x02})) // Ready to receive data
        // .then(() => device.transferIn(5, 64)) // Waiting for 64 bytes of data from endpoint #5.
        // .then(result => {
        // let decoder = new TextDecoder();
        // console.log('Received:', decoder.decode(result.data));
        // })
    })
    // Bind vote buttons
    $('.button-vote').click(function(){
        if (window.device) {
            device.transferOut(4, new Uint8Array([parseInt($(this).attr('party'))]))
        }
    })
    // Monitor incoming USB port data from Arduino
    async function monitorUSBInput () {
        while (true) {
            if (window.device) {
                let input = await device.transferIn(5, 64)
                let message = new TextDecoder().decode(input.data)
                console.log('Received:', message)
            } else {
                await wait(1)
            }
        }
    }
    function wait (seconds) {
        return new Promise(resolve => {
            setTimeout(() => {
                resolve()
            }, seconds * 1000)
        })
    }
    monitorUSBInput()
</script>
